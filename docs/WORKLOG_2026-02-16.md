# WORKLOG (2026-02-16)

## 목적
- Telegram 기반 Mode B 운영을 실제 가동 상태로 전환.
- `/work -> gate -> report` 흐름을 안정화하고, `/approve -> Cursor apply` 2단 승인 흐름을 추가.

## 오늘 완료한 핵심 작업
1. Mode B 운영 문서/자동화 고정
- `docs/MODE_B_OPERATION_RUNBOOK.md` 보강
- `scripts/mode_b_cycle.ps1` 추가 및 개선
  - `-LaunchClaude`, `-AutoStash`, `-Apply`, `-Commit`, `-Push` 지원
  - `git apply --check` + `gate_local.py` 통과 전 apply 금지

2. Orchestrator MVP 구축
- `orchestrator/` 스켈레톤 추가
  - `main.py`, `config.yaml`, `prompts/claude_patch_prompt.txt`, `utils/git_gate.py`
  - `orchestrator/README.md`, `orchestrator/requirements.txt`
- `.gitignore`에 orchestrator 산출물(`orchestrator/patches/*.patch`, `orchestrator/reports/*.json`) 반영

3. Telegram polling(/work) 핸들러 추가
- `orchestrator/main.py`에 `python-telegram-bot (Updater)` 기반 `/start`, `/work` 도입
- `--polling` 모드/one-shot 모드 병행 지원
- `allowed_chat_ids` 기반 채팅 제한

4. 2단 승인 흐름(무인 -> 사람) 반영
- `config/WORK_AUTODEV_CONFIG.json` 도입(버전 1.1.0)
- `orchestrator/tg_orchestrator.py` 반영:
  - `/work`, `/status`, `/stop`, `/resume`, `/help`
  - `/approve [task_id]` (없으면 마지막 PASS task)
  - `/reject [task_id]` (승인 플래그 삭제)
  - 승인 플래그 생성 경로:
    - `.autodev_queue/approved/<task_id>.approved.json`
- Cursor 전용 적용 스크립트 추가:
  - `scripts/cursor_apply_approved.ps1`

5. 운영 충돌/장애 해결
- `HTTP 409 Conflict` 해결:
  - 원인: 동일 Telegram bot token에 대해 다중 poller 동시 실행
  - 조치: 중복 poller 정리, 단일 orchestrator 인스턴스만 유지
- `repo_clean=False` 해결:
  - 원인: `.autodev_runtime/` untracked
  - 조치: `.gitignore` 보강 후 커밋

6. `/work` 입력 품질 개선
- 모호한 입력(예: `/work`, `/work readme`) 자동 거절 로직 추가
  - `WORK_TEXT_TOO_SHORT`
  - `WORK_TEXT_INTENT_MISSING`
  - `WORK_TEXT_TARGET_MISSING`
- 실패 시 Telegram 안내 + audit(`WORK_INPUT_REJECTED`) 기록

## 운영 상태(현재)
- Orchestrator 실행 확인:
  - `python -u ./orchestrator/tg_orchestrator.py`
- Telegram `/status` 기준:
  - `repo_clean: True`
  - `killswitch: False`
  - `engine: claude_code`
- Queue 승인 디렉토리 생성 완료:
  - `.autodev_queue/approved`

## 반영된 주요 커밋
- `8eef32d`: pilot patch apply (Mode B gate 기반)
- `965ebd3`: `mode_b_cycle.ps1` 자동화 추가
- `844a71f`: `-LaunchClaude` 인터랙티브 시나리오 문서화
- `bd3ddcf`: Mode B 스크립트 보강 커밋
- `c0148aa`: `patches/` ignore 반영
- `6cde4ea`: orchestrator MVP 스켈레톤
- `a66d7e0`: Telegram `/work` polling 핸들러 추가
- `aaebd7a`: `.autodev_runtime/`, `logs/` ignore 반영
- `3f8f910`: 2단 승인 흐름(`/approve`, cursor apply script) 반영

## 운영 규칙 요약
- 자동화가 하는 일: 제안(diff) + 검증(gate) + 리포트 + 승인 플래그
- 자동화가 하지 않는 일: apply/commit/push
- 최종 집행 권한: Cursor(Control-Plane) 수동 실행

## 다음 작업
1. `/approve` 이후 승인파일 기반 자동 PR 브랜치 생성(로컬만, push 금지) 옵션 추가 검토
2. `/work` 프롬프트 템플릿에 작업별 스키마(파일/라인 제한) 강제
3. 승인/거절 이벤트 대시보드용 요약 스크립트 확장(`audit` 집계)
